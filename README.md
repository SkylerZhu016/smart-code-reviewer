# 智能代码批阅助手

## 项目概述

智能代码批阅助手是一个基于Flask和人工智能技术的在线编程教学平台，专为Python编程教学设计。该系统集成了自动化代码测试、AI智能评审、实时辅导和PDF报告导出等功能，为教师和学生提供全方位的编程学习支持。

### 核心功能

- **智能代码评审**：基于DeepSeek AI模型的代码质量评估
- **自动化测试**：支持自定义测试用例的代码执行和验证
- **实时AI辅导**：学生可随时向AI导师提问，获得启发式指导
- **PDF报告生成**：自动生成包含代码分析、测试结果和AI评估的详细报告
- **双角色系统**：教师端和学生端分离，满足不同用户需求
- **代码编辑器**：集成Monaco编辑器，提供专业的代码编写体验

## 分工

本项目由6名团队成员共同开发完成，具体分工如下：

| 序号 | 姓名 | 学号 | 负责模块 |
|------|------|------|----------|
| 1 |    |    | 项目架构设计与后端开发 |
| 2 |    |    | 前端界面设计与实现 |
| 3 |    |    | AI服务集成与优化 |
| 4 |    |    | 数据库设计与维护 |
| 5 |    |    | 代码执行安全模块 |
| 6 |    |    | 测试用例设计与系统测试 |

## 技术架构

### 后端技术栈

- **框架**：Flask (Python Web框架)
- **数据库**：SQLite (轻量级关系型数据库)
- **AI服务**：DeepSeek API (大语言模型接口)
- **代码执行**：Python subprocess (安全的沙箱环境)
- **PDF生成**：FPDF库 (支持中文字体)

### 前端技术栈

- **基础**：HTML5, CSS3, JavaScript (ES6+)
- **编辑器**：Monaco Editor (VS Code同款编辑器)
- **UI框架**：自定义CSS组件系统
- **模块化**：ES6模块化架构
- **Markdown**：Marked.js (Markdown解析)

### 数据库设计

系统采用双数据库架构：

1. **教师数据库** (`teacher.db`)
   - `Problem`：题目信息表
   - `TestCase`：测试用例表
   - `TeacherAIReview`：教师端AI评估缓存表

2. **学生数据库** (`student.db`)
   - `Submission`：学生代码提交表
   - `StudentAIChat`：学生AI对话记录表
   - `StudentAIReview`：学生端AI评估记录表

## 目录结构

```
网站/
├── app.py                     # Flask应用主入口
├── startup.bat                # Windows启动脚本
├── README.md                  # 项目说明文档
├── database/                  # 数据库文件目录
│   ├── teacher.db             # 教师数据库
│   └── student.db             # 学生数据库
├── fonts/                     # 字体文件目录
│   ├── NotoSans-*.ttf         # 英文字体
│   └── SourceHanSansSC-*.otf  # 中文字体
├── scripts/                   # 后端Python模块
│   ├── __init__.py
│   ├── ai_service.py          # AI服务接口
│   ├── code_executor.py       # 代码安全执行
│   ├── config.py              # 配置文件
│   ├── database.py            # 数据库操作
│   ├── pdf_generator.py       # PDF报告生成
│   └── routes.py              # Flask路由定义
├── static/                    # 静态资源
│   ├── css/
│   │   └── style.css          # 主样式文件
│   ├── images/
│   │   ├── background.webp    # 背景图片
│   │   └── favicon.ico        # 网站图标
│   └── js/
│       ├── main.js            # 主入口文件
│       ├── marked.min.js      # Markdown解析库
│       ├── vs/                # Monaco编辑器资源 (VS Code同款)
│       └── modules/           # JavaScript模块
│           ├── ai-tutor.js
│           ├── app-state.js
│           ├── auth-manager.js
│           ├── code-runner.js
│           ├── editor-manager.js
│           ├── export-manager.js
│           ├── problem-manager.js
│           ├── student-view.js
│           ├── submission-manager.js
│           └── ui-manager.js
├── templates/                 # HTML模板
│   ├── index.html             # 主页面
│   └── prompt.json            # AI提示词模板
└── testfiles/                 # 测试用例示例
    ├── 1.1.py - 1.5.py        # 第一题示例代码
    ├── 2.1.py - 2.5.py        # 第二题示例代码
    └── 3.1.py - 3.4.py        # 第三题示例代码
```

## 安装与部署

### 环境要求

- **Python**: 3.7或更高版本
- **操作系统**: Windows 10/11, Linux (Ubuntu 18.04+), macOS 10.14+
- **内存**: 至少4GB RAM，推荐8GB以上
- **存储空间**: 至少500MB可用空间
- **网络**: 稳定的互联网连接（用于访问AI API）

### 依赖安装

#### 步骤一：安装Python
1. 访问 [Python官网](https://www.python.org/downloads/) 下载最新版Python
2. 安装时勾选"Add Python to PATH"选项
3. 验证安装：打开命令行，输入 `python --version` 或 `python3 --version`

#### 步骤二：下载项目文件
1. 将整个项目文件夹复制到本地目录
2. 确保所有子目录和文件结构完整

#### 步骤三：安装依赖包
打开命令行，进入项目根目录，执行以下命令：
pip install flask requests fpdf

### 配置说明

#### 1. API配置 (`scripts/config.py`)
按照以下步骤配置DeepSeek API：

1. 获取API密钥：
   - 访问 [DeepSeek官网](https://www.deepseek.com/)
   - 注册账号并登录
   - 在控制台生成API密钥

2. 编辑配置文件：
   ```python
   # 打开 scripts/config.py 文件
   API_KEY = "your-deepseek-api-key"  # 替换为实际的API密钥
   BASE_URL = "https://api.deepseek.com/v1"
   MODEL_NAME = "deepseek-chat"
   ```

3. 测试API连接：
   ```bash
   # 运行以下Python脚本测试连接
   python -c "
   import requests
   import json
   from scripts.config import API_KEY, BASE_URL, MODEL_NAME
   
   headers = {
       'Authorization': f'Bearer {API_KEY}',
       'Content-Type': 'application/json'
   }
   
   data = {
       'model': MODEL_NAME,
       'messages': [{'role': 'user', 'content': 'Hello, test connection'}],
       'max_tokens': 50
   }
   
   response = requests.post(f'{BASE_URL}/chat/completions', headers=headers, json=data)
   print('API连接状态:', '成功' if response.status_code == 200 else '失败')
   "
   ```

#### 2. 数据库配置
- 数据库文件会自动创建在 `database/` 目录下
- 首次运行时会自动初始化表结构
- 无需手动配置数据库

#### 3. 字体文件检查
确保以下字体文件存在于 `fonts/` 目录：
- NotoSans-*.ttf (英文字体)
- SourceHanSansSC-*.otf (中文字体)

### 启动方式

#### Windows系统启动

**方法一：使用启动脚本**
1. 双击项目根目录下的 `startup.bat` 文件
2. 等待命令行窗口出现并显示服务器启动信息
3. 看到类似 "Running on http://127.0.0.1:5000" 的提示后，表示启动成功

**方法二：命令行启动**
1. 打开命令提示符(CMD)或PowerShell
2. 切换到项目根目录：`cd /d "项目路径"`
3. 执行启动命令：`python app.py`
4. 等待启动完成

#### Linux/macOS系统启动

1. 打开终端
2. 切换到项目根目录：`cd "项目路径"`
3. 执行启动命令：
   ```bash
   python3 app.py
   # 如果系统默认使用Python 3
   python app.py
   ```
4. 等待启动完成

#### 启动验证

无论使用哪种方式，成功启动后应看到类似以下输出：
```
 * Serving Flask app 'app'
 * Running on http://127.0.0.1:5000 (Press CTRL+C to quit)
 * Restarting with stat
 * Debugger is active!
```

### 访问系统

启动成功后，使用以下步骤访问系统：

1. 打开现代Web浏览器（推荐使用Chrome、Firefox、Safari或Edge的最新版本）
2. 在地址栏输入：`http://localhost:5000`
3. 系统将显示主界面，默认为教师端视图

### 常见启动问题解决

1. **端口被占用错误**
   ```bash
   # 查看端口占用
   netstat -ano | findstr :5000  # Windows
   lsof -i :5000                  # Linux/macOS
   
   # 解决方法1：终止占用进程
   # 解决方法2：修改app.py中的端口设置
   ```

2. **模块导入错误**
   ```bash
   # 确保在项目根目录下启动
   # 检查Python路径是否正确
   # 重新安装依赖包
   ```

3. **权限问题**
   ```bash
   # Windows：以管理员身份运行命令提示符
   # Linux/macOS：使用适当的权限
   chmod +x startup.sh  # 如果存在
   ```

## 功能详解

### 教师端功能使用指南

#### 1. 题目管理

##### 1.1 创建新题目
1. **访问题目管理界面**
   - 登录系统后，在主界面找到"题目管理"选项卡
   - 点击进入题目管理页面

2. **填写题目信息**
   - 点击"创建新题目"按钮
   - 在弹出的表单中填写以下信息：
     * **题目标题**：简明扼要的题目名称，如"计算两数之和"
     * **难度级别**：选择简单、中等或困难
     * **题目描述**：使用Markdown格式详细描述题目要求和背景
     * **输入格式说明**：说明程序输入数据的格式和要求
     * **输出格式说明**：说明程序输出数据的格式和要求

3. **添加测试用例**
   - 在"测试用例"部分，点击"添加测试用例"
   - 为每个测试用例填写：
     * **输入数据**：程序运行时的标准输入
     * **预期输出**：程序应产生的标准输出
     * **测试用例说明**：简要描述此测试用例的目的
   - 建议至少添加3-5个测试用例，覆盖常见边界情况
   - 点击"保存测试用例"确认添加

4. **保存题目**
   - 确认所有信息填写无误后，点击"保存题目"按钮
   - 系统将显示保存成功提示，题目将出现在题目列表中

##### 1.2 编辑现有题目
1. **选择要编辑的题目**
   - 在题目列表中找到目标题目
   - 点击题目右侧的"编辑"按钮

2. **修改题目信息**
   - 在编辑页面中，可以修改题目的任何信息
   - 支持富文本编辑的题目描述
   - 可以添加、修改或删除测试用例

3. **保存修改**
   - 完成修改后，点击"保存更改"按钮
   - 系统将更新题目信息并提示保存成功

##### 1.3 删除题目
1. **选择要删除的题目**
   - 在题目列表中找到目标题目
   - 点击题目右侧的"删除"按钮

2. **确认删除**
   - 系统将弹出确认对话框
   - 注意：删除题目将同时删除所有相关的学生提交记录
   - 确认无误后，点击"确认删除"

#### 2. 代码评审

##### 2.1 查看学生提交
1. **访问提交列表**
   - 在主界面选择"提交管理"选项卡
   - 系统将显示所有学生的代码提交记录

2. **筛选提交记录**
   - 可以按题目、学生ID、提交时间筛选提交记录
   - 使用搜索框快速定位特定提交

3. **查看提交详情**
   - 点击提交记录右侧的"查看详情"按钮
   - 系统将显示完整的学生代码、测试结果和AI评估

##### 2.2 自动化测试结果查看
1. **测试结果概览**
   - 在提交详情页面，查看"测试结果"部分
   - 绿色表示测试通过，红色表示测试失败
   - 查看每个测试用例的输入和实际输出

2. **对比分析**
   - 系统会自动对比实际输出与预期输出
   - 高亮显示差异部分，便于快速定位问题

##### 2.3 AI智能评估
1. **获取AI评估**
   - 在提交详情页面，点击"获取AI评估"按钮
   - 系统将调用DeepSeek AI模型对代码进行分析

2. **评估结果解读**
   - **代码逻辑**：评估算法正确性和逻辑完整性
   - **代码规范**：检查命名规范、注释质量、结构清晰度
   - **性能效率**：分析时间复杂度、空间复杂度和优化潜力
   - **健壮性**：评估错误处理、边界条件和异常情况处理
   - **可读性**：评价代码风格、变量命名和注释说明

3. **AI评估操作**
   - 如需重新评估，点击"重新评估"按钮
   - 可以将评估结果保存为模板，供后续使用

##### 2.4 导出PDF评审报告
1. **生成报告**
   - 在提交详情页面，点击"导出PDF"按钮
   - 系统将收集代码、测试结果和AI评估

2. **自定义报告内容**
   - 可以选择报告包含的部分：
     * 题目描述和要求
     * 学生代码完整内容
     * 测试结果详情
     * AI评估分析
     * 教师评语（可选）
   - 填写教师评语（可选）

3. **下载报告**
   - 点击"生成并下载PDF"按钮
   - 浏览器将自动下载生成的PDF报告
   - 报告文件名格式：`题目ID_学生ID_提交时间.pdf`

#### 3. 批量管理

##### 3.1 查看所有学生提交记录
1. **访问提交概览**
   - 在主界面选择"批量管理"选项卡
   - 系统将显示所有题目的提交统计信息

2. **统计信息**
   - 查看每个题目的提交总数
   - 查看每个学生的提交次数
   - 查看通过率和平均得分

##### 3.2 批量导出评审报告
1. **选择要导出的提交**
   - 使用筛选器选择特定题目或学生
   - 可以按时间范围、通过率等条件筛选
   - 勾选需要导出的提交记录

2. **设置导出选项**
   - 选择报告包含的内容（代码、测试结果、AI评估等）
   - 设置报告命名规则
   - 选择导出格式（单个合并PDF或多个独立PDF）

3. **执行导出**
   - 点击"批量导出"按钮
   - 系统将显示导出进度
   - 完成后提供下载链接

##### 3.3 删除和管理提交记录
1. **批量删除**
   - 勾选需要删除的提交记录
   - 点击"批量删除"按钮
   - 在确认对话框中确认删除操作

2. **归档管理**
   - 选择需要归档的提交记录
   - 点击"归档"按钮将记录移至归档区
   - 归档的记录不会在主列表显示，但不会删除

3. **数据备份**
   - 点击"数据备份"按钮
   - 选择备份内容（题目、提交记录、评估结果等）
   - 系统将生成备份文件供下载

### 学生端功能使用指南

#### 1. 代码编写

##### 1.1 使用代码编辑器
1. **进入学生界面**
   - 在主界面点击"切换到学生端"按钮
   - 输入学生ID（根据教师提供的格式）
   - 点击"确认"进入学生界面

2. **选择题目**
   - 在题目列表中选择要完成的题目
   - 点击题目标题查看详细要求
   - 点击"开始编程"按钮进入代码编写界面

3. **使用编辑器功能**
   - **代码输入**：在编辑器区域直接输入代码
   - **语法高亮**：系统会自动为Python关键字、字符串、注释等添加颜色
   - **自动补全**：输入代码时按`Ctrl+Space`触发自动补全建议
   - **代码格式化**：按`Shift+Alt+F`或点击格式化按钮自动调整代码格式
   - **撤销/重做**：使用`Ctrl+Z`撤销，`Ctrl+Y`重做
   - **查找替换**：按`Ctrl+F`打开查找框，`Ctrl+H`打开替换框

##### 1.2 编辑器高级功能
1. **多光标编辑**
   - 按住`Alt`键点击多个位置创建多光标
   - 适合同时编辑多行相似的代码

2. **代码折叠**
   - 点击行号旁的箭头折叠/展开代码块
   - 适合隐藏已完成的函数或类

3. **分屏编辑**
   - 右键编辑器标签，选择"向右分屏"
   - 可以同时查看代码的不同部分

4. **主题切换**
   - 点击编辑器右上角设置图标
   - 选择喜欢的颜色主题（深色/浅色）

#### 2. 自测运行

##### 2.1 代码测试流程
1. **编写测试用例**
   - 在编辑器下方找到"测试用例"区域
   - 输入测试数据（模拟程序输入）
   - 参考题目要求的输入格式

2. **运行代码**
   - 点击"运行代码"按钮或按`F5`
   - 系统将执行当前代码并显示结果
   - 运行状态显示在编辑器下方

3. **查看运行结果**
   - **标准输出**：查看程序的print输出
   - **错误信息**：如有错误，显示详细的错误堆栈
   - **执行时间**：显示代码运行耗时

##### 2.2 结果对比分析
1. **对比预期输出**
   - 在"预期输出"区域输入题目要求的输出格式
   - 点击"对比结果"按钮
   - 系统会高亮显示实际输出与预期输出的差异

2. **调试技巧**
   - 使用`print()`语句在关键位置输出变量值
   - 检查边界条件：空输入、最大值、最小值等
   - 查看错误信息，定位问题所在的行号

3. **性能测试**
   - 对于大数据量的测试用例，关注执行时间
   - 如超时，考虑优化算法或数据结构

#### 3. AI辅导

##### 3.1 提问与解答
1. **访问AI辅导**
   - 在学生界面找到"AI辅导"选项卡
   - 点击进入AI对话界面

2. **有效提问技巧**
   - **具体问题**：不要问"我的代码为什么不工作"，而应问"我的代码在第X行出现了Y错误"
   - **提供上下文**：简要说明题目要求和你的解决思路
   - **展示代码**：粘贴相关的代码片段
   - **描述尝试**：说明你已经尝试过哪些解决方法

3. **提问示例**
   ```
   我正在解决一个排序问题，题目要求对一个列表进行升序排列。
   我的代码如下：
   ```python
   def bubble_sort(arr):
       for i in range(len(arr)):
           for j in range(len(arr)-i):
               if arr[j] > arr[j+1]:
                   arr[j], arr[j+1] = arr[j+1], arr[j]
       return arr
   ```
   当输入[3, 2, 1]时，出现了"IndexError: list index out of range"错误。
   请问是哪里出了问题？
   ```

##### 3.2 启发式教学方法
1. **概念解释**
   - AI会解释相关的编程概念
   - 提供简洁明了的例子和类比

2. **逐步引导**
   - AI不会直接给出完整答案
   - 而是通过提问引导你思考
   - 帮助你找到问题的根源

3. **代码优化建议**
   - 基于你当前的代码提供改进建议
   - 解释为什么要这样修改
   - 提供多种可能的解决方案

##### 3.3 学习历史记录
1. **查看对话历史**
   - 在AI辅导界面点击"历史记录"
   - 系统显示你与AI的所有对话
   - 可以按题目或日期筛选历史记录

2. **重要内容标记**
   - 点击对话旁的星标标记重要内容
   - 便于后续复习和查找

3. **导出学习笔记**
   - 选择多个对话记录
   - 点击"导出笔记"生成PDF或Markdown文件

#### 4. 提交管理

##### 4.1 正式提交流程
1. **代码最终检查**
   - 确保代码能够通过所有测试用例
   - 检查代码注释和变量命名
   - 运行一次最终测试确保没有错误

2. **执行提交**
   - 点击"提交代码"按钮
   - 在确认对话框中点击"确认提交"
   - 系统将显示提交成功消息

3. **提交注意事项**
   - 每个题目可以多次提交，但只记录最后一次有效提交
   - 提交后无法修改，请确保代码无误
   - 提交时间将被记录，注意截止时间

##### 4.2 查看历史提交记录
1. **访问提交历史**
   - 在学生界面点击"提交历史"选项卡
   - 系统显示你所有题目的提交记录

2. **筛选和排序**
   - 按题目、提交时间、得分筛选记录
   - 按提交时间升序或降序排列

3. **查看提交详情**
   - 点击任意提交记录查看详细信息
   - 包括代码内容、测试结果和AI评估

##### 4.3 获取AI评估反馈
1. **自动评估**
   - 提交后系统会自动调用AI进行评估
   - 评估通常需要几秒钟到一分钟
   - 完成后你会收到通知

2. **评估内容解读**
   - **整体评分**：代码质量综合评分（0-100分）
   - **维度分析**：从逻辑、规范、性能、健壮性、可读性五个维度评价
   - **改进建议**：具体的代码改进建议和学习资源推荐

3. **基于反馈的学习**
   - 重点关注评分较低的维度
   - 根据AI建议修改代码
   - 可以重新提交查看改进效果

4. **与教师反馈对比**
   - 如果教师也提供了评价，可以对比AI和教师的评价
   - 理解不同角度的代码质量评价标准

### AI评估系统

系统使用DeepSeek大语言模型进行代码分析，评估维度包括：

- **代码逻辑**：算法正确性、逻辑完整性
- **代码规范**：命名规范、注释质量、结构清晰度
- **性能效率**：时间复杂度、空间复杂度、优化潜力
- **健壮性**：错误处理、边界条件、异常情况
- **可读性**：代码风格、变量命名、注释说明

## API接口文档

### 题目管理

- `GET /api/problems` - 获取所有题目列表
- `GET /api/problems/<id>` - 获取指定题目详情
- `POST /api/problems` - 创建新题目
- `POST /api/problems/<id>` - 更新题目
- `DELETE /api/problems/<id>` - 删除题目

### 代码提交与测试

- `POST /api/test/<problem_id>` - 测试代码（不保存）
- `POST /api/submit/<problem_id>` - 提交代码并保存
- `GET /api/submissions/<problem_id>` - 获取题目提交列表
- `GET /api/submission/<submission_id>` - 获取提交详情
- `DELETE /api/submission/<submission_id>` - 删除提交记录

### AI服务

- `POST /api/review` - AI代码评审
- `GET /api/review/<submission_id>` - 获取缓存的评审结果
- `POST /api/export_pdf` - 导出PDF报告

### 学生功能

- `GET /api/student/latest-submission/<problem_id>/<student_id>` - 获取最新提交
- `GET /api/student/chat-history/<problem_id>/<student_id>` - 获取聊天历史
- `GET /api/student/review-history/<problem_id>/<student_id>` - 获取评估历史

## 安全特性

1. **代码执行沙箱**
   - 使用临时文件隔离执行环境
   - 设置执行超时限制（默认10秒）
   - 严格的输入输出控制

2. **数据验证**
   - 前后端双重数据验证
   - SQL注入防护
   - XSS攻击防护

3. **访问控制**
   - 基于角色的功能分离
   - 学生ID验证机制
   - 敏感操作权限控制

## 扩展与定制

### 添加新的编程语言支持

1. 修改 `scripts/code_executor.py` 中的执行逻辑
2. 更新前端Monaco编辑器的语言配置
3. 调整AI提示词模板以适应新语言

### 自定义AI评估标准

编辑 `templates/prompt.json` 文件中的提示词模板，可以调整：
- 评估维度和权重
- 输出格式和内容
- 教学风格和语气

### 扩展数据库功能

1. 在 `scripts/database.py` 中添加新表结构
2. 在 `scripts/routes.py` 中实现相应的API接口
3. 更新前端JavaScript模块以支持新功能

## 故障排除

### 常见问题

1. **AI服务无响应**
   - 检查API密钥是否正确
   - 确认网络连接正常
   - 查看API调用限制

2. **代码执行失败**
   - 检查Python环境是否正确安装
   - 确认临时文件权限
   - 查看代码执行超时设置

3. **PDF生成错误**
   - 确认字体文件存在
   - 检查中文字体支持
   - 查看PDF生成超时设置

### 日志查看

系统日志会输出到控制台，包括：
- API调用状态
- 数据库操作记录
- 错误和异常信息
- AI服务响应状态

## 联系方式

如有问题或建议，请通过以下方式联系：
- 邮箱：[2868532894@qq.com]

---

**注意**：本系统仅用于教学目的，请确保在生产环境中部署时加强安全措施。